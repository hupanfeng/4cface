<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=EmulateIE10;IE=EmulateIE9">
    <meta name="renderer" content="webkit"/>
    <meta http-equiv="X-UA-Compatible" content="edge"/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <link rel="shortcut icon" href="/style/images/index/favicon.png"/>
    <link rel="stylesheet" type="text/css" href="../js/lib/easyui1.4.4/themes/default/easyui.css">
    <link rel="stylesheet" type="text/css" href="../js/lib/easyui1.4.4/themes/icon.css">
    <link rel="stylesheet" type="text/css" href="../style/wb.css">
    <link rel="stylesheet" type="text/css" href="../style/main.css"/>
    <script type="text/javascript" src="../js/loader.js"></script>
    <script type="text/javascript" charset="utf-8" src="../ueditor/ueditor.config.js"></script>
    <script type="text/javascript" charset="utf-8" src="../ueditor/ueditor.all.min.js"></script>
    <!--建议手动加在语言，避免在ie下有时因为加载语言失败导致编辑器加载失败-->
    <!--这里加载的语言文件会覆盖你在配置项目里添加的语言类型，比如你在配置项目里配置的是英文，这里加载的中文，那最后就是中文-->
    <script type="text/javascript" charset="utf-8" src="../ueditor/lang/zh-cn/zh-cn.js"></script>
    <!--<script type="text/javascript" charset="utf-8" src="../ueditor/third-party/jquery-1.10.2.min.js"></script>-->
    <script src="../js/lib/store.js" charset="utf-8"></script>
</head>

<body class="easyui-layout" data-options="fit:true,border:false">
<div data-options="region:'center',border:false" class="editBox" title="">
    <div id="toolbar" style="line-height:40px">
        <span class="datagrid-btn-separator"></span>
        <a href="javascript:void(0);" class="easyui-linkbutton" data-options="plain:true,iconCls:'icon-save'"
           onclick="submitFrom()">提交模板</a>
    </div>
    <form id="form" method="post">
        <input id="mid" name="mid" type="hidden"/>
        <table class="grid">
            <tr>
                <td align="center">模板名称</td>
                <td style="width: 40%;">
                    <input name="templateName" id="templateName" class="easyui-textbox"
                           data-options="required:true,prompt:'请输入模板名'" style="width:55%;height:30px">
                </td>
                <td align="center">类&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;别</td>
                <td style="width: 40%;">
                    <input id="categoryId" name="categoryId" class="easyui-combobox" style="width:55%;height:30px"/>
                </td>
            </tr>
            <tr>
                <td align="center">模板描述</td>
                <td colspan="3">
                    <input name="description" id="description" class="easyui-textbox" data-options="multiline:true"
                           style="height: 100px;width:80%;"/>
                </td>
            </tr>
        </table>
    </form>
    <a href="javascript:void(0);" class="easyui-linkbutton" data-options="plain:false,iconCls:'icon-add'"
       onclick="addTemplate()" style="line-height:30px;padding:0;margin-left: 5px">新增模块</a>
</div>
<script type="text/javascript">
    var url = '';
    loader.load('common', function () {
        var data = parent.window.datas;
        var pcate = "";
        if (data) {
            url = 'edit';
            $("#templateName").val(data.templateName);
            $("#description").val(data.description);
            $("#content").val(data.content);
            $("#mid").removeAttr("disabled");
            $("#mid").val(data.mid);
            pcate = data.categoryIds;
            parent.window.datas = null;
            $.each(data.contents, function (index, obj) {
                addTemplate(obj);
            });
        } else {
            url = 'add';
            $("#mid").attr("disabled", "disabled");
        }

        $(function () {
            $('#form').form({
                onSubmit: function () {
                    progressLoad();
                    var isValid = $(this).form('validate');
                    if (!isValid) {
                        progressClose();
                    }
                    return isValid;
                },
                success: function (result) {
                    progressClose();
                    result = $.parseJSON(result);
                    if (result.success) {
                        parent.window.refresh();
                        parent.window.closeTab();
                        $.messager.alert('提示', result.msg, 'info');
                        delete parent.window.refresh;
                    } else {
                        $.messager.alert('错误', result.msg, 'error');
                    }
                }
            });
            $.ajax({
                type: "get",
                url: store.get("context") + "/toolcategory/dataGrid",
                dataType: "json",
                cache: false,
                success: function (result) {
                    var tree = new Array();
                    var treeNodeAll = new Object();
                    treeNodeAll.id = -100;
                    treeNodeAll.text = "全选 ";
                    tree.push(treeNodeAll)
                    result.rows.forEach(function (it) {
                        var treeNode = new Object();
                        treeNode.id = it.mid;
                        treeNode.text = it.categoryName;
                        treeNode.pid = it.pid;
                        tree.push(treeNode);
                    });
                    $("#categoryId").combotree({
                        data: tree,
                        parentField: "pid",
                        value: pcate,
                        editable: false,
                        multiple: true,
                        cascadeCheck: false,
                        required: true,
                        onLoadSuccess: function () {
                            $('#categoryId').combotree("tree").tree('collapseAll')
                        },
                        onCheck: function (node, checked) {
                            var tr = $("#categoryId").combotree("tree");
                            if (checked) {
                                var childNode;
                                childNode = tr.tree("getChildren", node.target);
                                for (var i = 0; i < childNode.length; i++) {
                                    tr.tree("check", childNode[i].target);
                                }
                            } else {
                                var childNode = tr.tree("getChildren", node.target);
                                for (var i = 0; i < childNode.length; i++) {
                                    tr.tree("uncheck", childNode[i].target);
                                }
                            }
                        }
                    });
                }
            });
        });
    });
    function submitFrom() {
        var ueditorConet = $("[name = 'templateContent']").length;
        if (ueditorConet <= 0) {
            $.messager.alert('提示', '请添加模板内容', 'info');
            return;
        }
        for (var i = 1; i <= ueditorConet; i++) {
            var context = UE.getEditor('editor' + i).getContent();
            $("#content" + i).val(context);
        }
        $("#form").form({
            url: url
        });
        $("#form").submit();
    }
    var count = 0;
    function addTemplate(data) {
        count++;
        var html = "<tr count='" + count + "'>" +
                "<td align='center'>序&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;号</td>" +
                "<td style='width: 40%;'>" +
                "<input name='orderNum' value='" + (count) + "' class='easyui-numberspinner'data-options='required:true,min:0,max:1000,editable:true' style='width: 55%;height:28px;'>" +
                "</td>" +
                "<td align='center'>是否公共</td>" +
                "<td style='width: 40%;'>" +
                "<select name='isPub' class='easyui-combobox' data-options='editable:false' style='width:55%;height:28px;'>" +
                "<option value='1'>是</option>" +
                "<option value='2'>否</option>" +
                "</select>" +
                "</td>" +
                "</tr>" +
                "<tr count='" + count + "'>" +
                "<td align='center'>内&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;容</td>" +
                "<td  colspan='3'>" +
                "<input type='hidden' name='templateContent' id='content" + count + "'/>" +
                "<script id='editor" + count + "' type='text/plain' style='width:90%;height:200px;'></scr" + "ipt>" +
                "<a href='javascript:void(0);' class='easyui-linkbutton' data-options='plain:false,iconCls:\"icon-remove\"' style='margin-left: 20;margin-top: 10px;' onclick='deleteTemp(" + count + ")'>移除模块</a>" +
                "</td>" +
                "</tr>" +
                "<tr count='" + count + "'>" +
                "</tr>";
        if (data) {
            $(".grid").append(html);
            $("[name = 'orderNum']").numberspinner({
                value: data.orderNum
            });
            $("[class='easyui-linkbutton']").linkbutton({});
            $("[name = 'isPub']").combobox({
                value: data.ispub
            });
            UE.getEditor('editor' + count, {
                autoHeightEnabled: false,
                autoFloatEnabled: false
            });
            var index = count;
            UE.getEditor('editor' + count).addListener("ready", function () {
                UE.getEditor('editor' + index).execCommand("inserthtml", data.content, true);
            });
        } else {
            $(".grid").append(html);
            $("[name = 'orderNum']").numberspinner({});
            $("[name = 'isPub']").combobox({});
            $("[class='easyui-linkbutton']").linkbutton({});
            UE.getEditor('editor' + count, {
                autoHeightEnabled: false,
                autoFloatEnabled: false
            });
        }
    }
    function deleteTemp(tempid) {
        $("[count=" + tempid + "]").remove();
    }
</script>
</body>
</html>
