<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=EmulateIE10;IE=EmulateIE9">
    <meta name="renderer" content="webkit"/>
    <meta http-equiv="X-UA-Compatible" content="edge"/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <link rel="shortcut icon" href="/style/images/index/favicon.png"/>
    <link rel="stylesheet" type="text/css" href="../js/lib/easyui1.4.4/themes/default/easyui.css">
    <link rel="stylesheet" type="text/css" href="../js/lib/easyui1.4.4/themes/icon.css">
    <link rel="stylesheet" type="text/css" href="../style/wb.css">
    <link rel="stylesheet" type="text/css" href="../style/main.css"/>

    <title>菜单管理</title>
</head>
<body class="easyui-layout" data-options="fit:true,border:false">
<div data-options="region:'center',border:false">
    <table id="dataGrid" class="easyui-datagrid">
        <thead>
        <tr>
            <th data-options="field:'templateName',sortable:true,align:'left',width:150">模板名称</th>
            <th data-options="field:'description',sortable:true,align:'left',width:550">模板描述</th>
            <th data-options="field:'action',width:150,align:'center'" formatter="showaction">操作</th>
        </tr>
        </thead>
    </table>
</div>
<div data-options="region:'west',border:false,split:true" title="知识类别"
     style="width:200px;overflow: hidden;overflow-y:auto; ">
    <ul id="categoryTree" style="width:180px;margin: 10px 10px 10px 10px">
        <li data-options="field:'categoryName',sortable:true,width:80"></li>
    </ul>
    <div id="toolbar" style="display: none;">
        <a resource="add" onclick="gotoTemplate('添加模板','doctemplate/doctemplate.html',null,refresh,null,'add');"
           href="javascript:void(0);"
           class="easyui-linkbutton"
           data-options="plain:true,iconCls:'icon-add'">添加</a>
        <span class="datagrid-btn-separator"></span>
        <a resource="edit" onclick="gotoTemplate('修改模板','doctemplate/doctemplate.html',null,refresh,null,'edit');"
           href="javascript:void(0);" class="easyui-linkbutton"
           data-options="plain:true,iconCls:'icon-edit'">修改</a>
        <span class="datagrid-btn-separator"></span>
        <a resource="delete" onclick="del(null,'delete');" href="javascript:void(0);" class="easyui-linkbutton"
           data-options="plain:true,iconCls:'icon-remove'">删除</a>
    </div>
</div>
<script type="text/javascript" src="../js/loader.js"></script>
<script type="text/javascript">
    var categoryId = "";
    loader.load('common', function () {
        $(function () {
            $.ajax({
                type: "get",
                url: store.get("context") + "/toolcategory/dataGrid",
                dataType: "json",
                cache: false,
                success: function (result) {
                    var tree = new Array();
                    result.rows.forEach(function (it) {
                        var treeNode = new Object();
                        treeNode.id = it.mid;
                        treeNode.text = it.categoryName;
                        treeNode.pid = it.pid;
                        tree.push(treeNode);
                    });
                    $('#categoryTree').tree({
                        data: tree,
                        parentField: 'pid',
                        lines: true,
                        onLoadSuccess: function () {$('#categoryTree').tree('collapseAll')},
                        onClick: function (node) {
                            categoryId = node.id;
                            getData(categoryId);
                        }
                    });
                }
            });
            getData();
            $("#toolbar").find("a").each(function () {
                var resource = $(this).attr("resource");
                if (!isPermit(resource)) {
                    $(this).hide();
                    $(this).next().remove();
                }
            });
        });
    });
    function getData(categoryId) {
        var url;
        if (categoryId) {
            url = "dataGrid?categoryId=" + categoryId;
        } else {
            url = "dataGrid?categoryId";
        }
        $('#dataGrid').datagrid({
            toolbar: "#toolbar",
            url: url,
            remoteSort: true,
            sortName: "mid",
            sortOrder: "asc",
            rownumbers: true,
            pagination: true,
            pagePosition: "bottom",
            pageList: [10, 50, 100, 200, 500],
            pageSize: 10,
            singleSelect: "true",
            onDblClickRow: function (rowindex, rowdata) {
                if (isPermit("edit")) {
                    gotoTemplate('修改模板', 'doctemplate/doctemplate.html', null, refresh, rowdata.mid, 'edit');
                }
            }
        });
    }
    var refresh = function refresh() {
        $("#dataGrid").datagrid('reload');
    }
    function gotoTemplate(title, url, iconCls, refresh, mid, tag) {
        parent.window.refresh = refresh;
        if (tag == 'edit') {
            var data = new Object();
            if (mid == null) {
                var rows = $('#dataGrid').datagrid('getSelections');
                if (rows == '') {
                    $.messager.alert('提示', '请选择您要编辑的项', 'info');
                    return;
                }
                mid = rows[0].mid;
            }
            $.ajax({
                type: "get",
                dataType: "json",
                url: mid,
                cache: false,
                success: function (result) {
                    data = result;
                    parent.window.datas = data;
                }
            });
        }
        parent.window.addTab({title: title, url: url, iconCls: iconCls});
    }
    window.showaction = function (value, row, index) {
        var object = {};
        object["select"] = {"func": "groupFun", "paramid": row.mid, "name": "预览"};
        return pubAction(object);
    }
    window.groupFun = function (param) {
        var data = {
            id: param
        };
        pop("doctemeplateView.html", "预览", 500, 500, null, data);
    }
</script>
</body>
</html>