<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=EmulateIE10;IE=EmulateIE9">
    <meta name="renderer" content="webkit"/>
    <meta http-equiv="X-UA-Compatible" content="edge"/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <link rel="shortcut icon" href="/style/images/index/favicon.png"/>
    <link rel="stylesheet" type="text/css" href="../js/lib/easyui1.4.4/themes/default/easyui.css">
    <link rel="stylesheet" type="text/css" href="../js/lib/easyui1.4.4/themes/icon.css">
    <link rel="stylesheet" type="text/css" href="../style/wb.css">
    <link rel="stylesheet" type="text/css" href="../style/main.css"/>

    <title>文档管理</title>
</head>
<body class="easyui-layout" data-options="fit:true,border:false">
<div data-options="region:'center',border:false">
    <form id="searchForm">
        <strong style="margin-right: 5px">标题:</strong>
        <input name="title" placeholder="请输入文档标题" class="easyui-textbox" style="width:200px;height:28px"/>
        <span class="datagrid-btn-separator"></span>
        <strong style="margin-right: 5px">作者:</strong>
        <input name="authorName" placeholder="请输入文档作者" class="easyui-textbox" style="width:200px;height:28px"/>
        <span class="datagrid-btn-separator"></span>
        <a href="javascript:void(0);" class="easyui-linkbutton" style="padding: 0 20px;"
           data-options="iconCls:'icon_search'" onclick="ubenSearch();">查询</a>
        <span class="datagrid-btn-separator"></span>
        <a href="javascript:void(0);" class="easyui-linkbutton" data-options="iconCls:'icon_cancel',plain:true"
           onclick="ubenClean();">清空</a>
    </form>
    <table id="dataGrid" class="easyui-datagrid">
        <thead>
        <tr>
            <th data-options="field:'title',sortable:true,align:'left',width:280">文档标题</th>
            <th data-options="field:'authorName',sortable:true,align:'center',width:150">作者</th>
            <th data-options="field:'status',sortable:true,align:'center',width:150" formatter="showStatus">状态</th>
            <th data-options="field:'toolCount',sortable:true,align:'center',width:150">工具数量</th>
            <th data-options="field:'action',width:150,align:'center'" formatter="showaction">操作</th>
        </tr>
        </thead>
    </table>
</div>
<div data-options="region:'west',border:false,split:true" title="知识类别"
     style="width:200px;overflow: hidden;overflow-y:auto; ">
    <ul id="categoryTree" style="width:180px;margin: 10px 10px 10px 10px">
        <li data-options="field:'categoryName',sortable:true,width:80"></li>
    </ul>
</div>
<div id="toolbar" style="display: none;">

    <a resource="add" onclick="addTab('添加文档','doc/doc.html',null,refresh,null,'add');"
       href="javascript:void(0);"
       class="easyui-linkbutton"
       data-options="plain:true,iconCls:'icon-add'">添加</a>
    <span class="datagrid-btn-separator"></span>
    <a resource="edit" onclick="addTab('修改文档','doc/doc.html',null,refresh,null,'edit');"
       href="javascript:void(0);" class="easyui-linkbutton"
       data-options="plain:true,iconCls:'icon-edit'">修改</a>
    <span class="datagrid-btn-separator"></span>
    <a resource="delete" onclick="del(null,'delete');" href="javascript:void(0);" class="easyui-linkbutton"
       data-options="plain:true,iconCls:'icon-remove'">删除</a>
</div>
<script type="text/javascript" src="../js/loader.js"></script>
<script type="text/javascript">
    var categoryId = "";
    loader.load('common', function () {
        $(function () {
            $.ajax({
                type: "get",
                url: store.get("context") + "/toolcategory/dataGrid",
                dataType: "json",
                cache: false,
                success: function (result) {
                    var tree = new Array();
                    result.rows.forEach(function (it) {
                        var treeNode = new Object();
                        treeNode.id = it.mid;
                        treeNode.text = it.categoryName;
                        treeNode.pid = it.pid;
                        tree.push(treeNode);
                    });
                    $('#categoryTree').tree({
                        data: tree,
                        parentField: 'pid',
                        lines: true,
                        onLoadSuccess: function () {
                            $('#categoryTree').tree('collapseAll')
                        },
                        onClick: function (node) {
                            categoryId = node.id;
                            getData(categoryId);
                        }
                    });
                    getData();
                }
            });
            $("#toolbar").find("a").each(function () {
                var resource = $(this).attr("resource");
                if (!isPermit(resource)) {
                    $(this).hide();
                    $(this).next().remove();
                }
            });
        });
    });
    function getData(categoryId) {
        var url;
        if (categoryId) {
            url = "dataByUser?categoryId=" + categoryId;
        } else {
            url = "dataByUser";
        }
        $('#dataGrid').datagrid({
            toolbar: "#toolbar",
            url: url,
            remoteSort: true,
            sortName: "mid",
            sortOrder: "asc",
            rownumbers: true,
            pagination: true,
            pagePosition: "bottom",
            pageList: [10, 50, 100, 200, 500],
            pageSize: 10,
            singleSelect: "true",
            onDblClickRow: function (rowindex, rowdata) {
                if (isPermit("edit")) {
                    addTab('修改文档', 'doc/doc.html', null, refresh, rowdata.mid, 'edit');
                }
            }
        });
    }
    var refresh = function refresh() {
        $("#dataGrid").datagrid('reload');
    }
    function addTab(title, url, iconCls, refresh, mid, tag) {
        parent.window.refresh = refresh;
        if (tag == 'edit') {
            var data = new Object();
            if (mid == null) {
                var rows = $('#dataGrid').datagrid('getSelections');
                if (rows == '') {
                    $.messager.alert('提示', '请选择您要编辑的项', 'info');
                    return;
                }
                mid = rows[0].mid;
            }
            $.ajax({
                type: "get",
                url: "get/" + mid,
                dataType: "json",
                cache: false,
                success: function (result) {
                    parent.window.datas = result;
                }
            });
        }
        parent.window.addTab({title: title, url: url, iconCls: iconCls});
    }
    window.showaction = function (value, row, index) {
        var object = {};
        object["select"] = {"func": "groupFun", "paramid": row.mid, "name": "预览"};
        if (isPermit("reviewed") && row.status == 1) {
            object["reviewed"] = {"func": "reviewed", "paramid": row.mid + "," + row.title, "name": "审核"};
        }
        object["tools"] = {"func": "openTool", "paramid": row.mid, "name": "工具信息"};
        return pubAction(object);
    }

    window.openTool = function(param){
        pop("toolInfoList.html", "工具", 800, null, null, param);
    }

    window.groupFun = function (param) {
        window.open(store.get("context") + "/docInfo.html?id=" + param);
    }
    window.reviewed = function (param) {
        var params = param.split(",");
        var mid = params[0];
        var title = params[1];
        parent.window.refresh = refresh;
        parent.window.addTab({title: title, url: 'doc/docReviewed.html', iconCls: null});
        parent.window.datas = mid;
    }
    function showStatus(value, row, index) {
        switch (value) {
            case 0 :
                return "草稿";
                break;
            case 1 :
                return "待审核";
                break;
            case 2 :
                return "审核通过";
                break;
            case 3 :
                return "审核不通过";
                break;
            default :
                return "未知";
                break;
        }
    }
</script>
</body>
