<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=EmulateIE10;IE=EmulateIE9">
    <meta name="renderer" content="webkit"/>
    <meta http-equiv="X-UA-Compatible" content="edge"/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <link rel="shortcut icon" href="/style/images/index/favicon.png"/>
    <link rel="stylesheet" type="text/css" href="../js/lib/easyui1.4.4/themes/default/easyui.css">
    <link rel="stylesheet" type="text/css" href="../js/lib/easyui1.4.4/themes/icon.css">
    <link rel="stylesheet" type="text/css" href="../style/wb.css">
    <link rel="stylesheet" type="text/css" href="../style/main.css"/>
    <script type="text/javascript" src="../js/loader.js"></script>
    <script type="text/javascript" charset="utf-8" src="../ueditor/ueditor.config.js"></script>
    <script type="text/javascript" charset="utf-8" src="../ueditor/ueditor.all.min.js"></script>
    <!--建议手动加在语言，避免在ie下有时因为加载语言失败导致编辑器加载失败-->
    <!--这里加载的语言文件会覆盖你在配置项目里添加的语言类型，比如你在配置项目里配置的是英文，这里加载的中文，那最后就是中文-->
    <script type="text/javascript" charset="utf-8" src="../ueditor/lang/zh-cn/zh-cn.js"></script>
    <!--<script type="text/javascript" charset="utf-8" src="../ueditor/third-party/jquery-1.10.2.min.js"></script>-->
    <script src="../js/lib/store.js" charset="utf-8"></script>
</head>
<body class="easyui-layout" data-options="fit:true,border:false">
<div data-options="region:'center',border:false" class="editBox" title="">
    <div id="toolbar" style="line-height:40px">
        <a href="javascript:void(0);" class="easyui-linkbutton" data-options="plain:true,iconCls:'icon-save'"
           onclick="submitFrom()">提交文档</a>
        <span class="datagrid-btn-separator"></span>
        <a href="javascript:void(0);" class="easyui-linkbutton" data-options="plain:true,iconCls:'icon-save'"
           onclick="savedraft()">保存草稿</a>
    </div>
    <form id="form" method="post" enctype="multipart/form-data">
        <input id="mid" name="mid" type="hidden"/>
        <table class="grid">
            <tr>
                <td align="center">文档标题</td>
                <td colspan="3">
                    <input name="title" id="title" class="easyui-textbox"
                           data-options="width:800,required:true,prompt:'请输入文档标题'"
                           style="height:28px;background-color: #fff;">
                </td>
            </tr>
            <tr>
                <td align="center">文档摘要</td>
                <td colspan="3">
                    <input name="summary" id="summary" class="easyui-textbox" data-options="multiline:true"
                           style="height: 100px;width:800px;">
                </td>
            </tr>
            <tr>
                <td align="center">封面图片</td>
                <td colspan="3">
                    <input name="uploadFile" id="uploadFile" class="easyui-filebox"
                           data-options="width:800,buttonText:'选择图片',prompt:'选择封面图片'">
                </td>
            </tr>
            <tr id="templateTr">
                <td align="center">类&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;别</td>
                <td>
                    <input id="categoryId" name="categoryId" class="easyui-combobox" style="width:200px;height:28px"/>
                </td>
            </tr>
        </table>
        <input id="content" name="content" type="hidden"/>
        <input id="status" name="status" type="hidden"/>
    </form>
    <a href="javascript:void(0);" class="easyui-linkbutton" data-options="plain:false,iconCls:'icon-add'"
       onclick="addTemplateContent()" style="margin-left:10px">新增模块</a>
</div>
<script type="text/javascript">
    var url = '';
    var data = null;
    loader.load('common', function () {
        data = parent.window.datas;
        var pcate = "";
        if (data) {
            url = 'edit';
            $("#mid").removeAttr("disabled");
            $("#mid").val(data.mid);
            $("#title").val(data.title);
            $("#summary").val(data.summary);
            pcate = data.categoryId;
            parent.window.datas = null;
            if(data.contentList){
                $.each(data.contentList, function (index, obj) {
                    addTemplateContent(obj, data.contentList.length);
                });
            }
        } else {
            url = 'add';
            $("#mid").attr("disabled", "disabled");
        }
        $(function () {
            $('#form').form({
                onSubmit: function () {
                    progressLoad();
                    var isValid = $(this).form('validate');
                    if (!isValid) {
                        progressClose();
                    }
                    return isValid;
                },
                success: function (result) {
                    progressClose();
                    result = $.parseJSON(result);
                    if (result.success) {
                        parent.window.refresh();
                        parent.window.closeTab();
                        $.messager.alert('提示', result.msg, 'info');
                        delete parent.window.refresh;
                    } else {
                        $.messager.alert('错误', result.msg, 'error');
                    }
                }
            });
            $.ajax({
                type: "get",
                url: store.get("context") + "/toolcategory/dataGrid",
                cache: false,
                dataType: "json",
                success: function (result) {
                    var tree = new Array();
                    result.rows.forEach(function (it) {
                        var treeNode = new Object();
                        treeNode.id = it.mid;
                        treeNode.text = it.categoryName;
                        treeNode.pid = it.pid;
                        tree.push(treeNode);
                    });
                    $("#categoryId").combotree({
                        data: tree,
                        parentField: "pid",
                        value: pcate,
                        editable: false,
                        required: true,
                        onLoadSuccess: function () {
                            $("#categoryId").combotree("tree").tree('collapseAll')
                        },
                        onSelect: function (r) {
                            $("[group='group']").remove();
                            if (!data) {
                                getTemplate(r.id, null);
                            }
                        }
                    });
                },
                error: function (result) {

                }
            });
            UE.Editor.prototype._bkGetActionUrl = UE.Editor.prototype.getActionUrl;
            UE.Editor.prototype.getActionUrl = function (action) {
                if (action == 'uploadimage') {
                    return store.get("context") + '/ueditor/upload/image';
                } else if (action == 'uploadvideo') {
                    return store.get("context") + '/ueditor/upload/video';
                } else if (action == 'uploadfile') {
                    return store.get("context") + '/ueditor/upload/file';
                } else if (action == 'listimage') {
                    return store.get("context") + '/ueditor/list/image';
                } else if (action == 'listfile') {
                    return store.get("context") + '/ueditor/list/file';
                } else {
                    return this._bkGetActionUrl.call(this, action);
                }
            }
        });
    });
    function submitFrom() {
        var noHtmlText = "";
        var ueditorConet = $("[name = 'contents']").length;
        if (ueditorConet <= 0) {
            $.messager.alert('提示', '请选择模板添加', 'info');
            return;
        }
        for (var i = 1; i <= count; i++) {
            var context = UE.getEditor('editor' + i).getContent();
            noHtmlText += UE.getEditor('editor' + i).getContentTxt();
            $("#content" + i).val(context);
            store.remove('editor' + i);
        }
        $("#content").val(noHtmlText);
        $("#status").val(1);
        $("#form").form({
            url: url
        });
        $("#form").submit();
    }
    var count = 0;
    function addTemplateContent(data, length) {
        count++;
        var html = "<tr count='" + count + "' group='editor'>" +
                "<td align='center'>序&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;号</td>" +
                "<td>" +
                "<input name='orderNum' id='orderNum" + count + "' value='" + count + "' class='easyui-numberspinner'data-options='width:200,height:28,required:true,min:0,max:1000,editable:true'>" +
                "</td>" +
                "<td align='center'>是否公共</td>" +
                "<td>" +
                "<select name='isPub'id='isPub" + count + "' class='easyui-combobox' data-options='width:200,height:28,editable:false'>" +
                "<option value='1'>是</option>" +
                "<option value='2'>否</option>" +
                "</select>" +
                "</td>" +
                "</tr>" +
                "<tr count='" + count + "' group='editor'>" +
                "<td align='center'>内&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;容</td>" +
                "<td colspan='3'>" +
                "<input type='hidden' name='contents'  id='content" + count + "'/>" +
                "<script id='editor" + count + "' type='text/plain' style='width:800;height:200px;'></scr" + "ipt>" +
                "</td>" +
                "</tr>" +
                "<tr count='" + count + "' group='editor'>" +
                "<td colspan='4'>" +
                "<a href='javascript:void(0);' style='margin-left:5px' class='easyui-linkbutton' data-options='plain:false,iconCls:\"icon-remove\"' onclick='deleteTemp(" + count + ")'>移除模块</a>" +
                "</td>" +
                "</tr>";
        $(".grid").append(html);
        UE.getEditor('editor' + count, {
            autoHeightEnabled: true,
            autoFloatEnabled: true,
            enterTag: 'br',//去除自动添加p标签
            allowDivTransToP: false//变成p
        });
        var index = count;

        if (!data) {
            $("[name = 'orderNum']").numberspinner({});
            $("[class='easyui-linkbutton']").linkbutton({});
            $("[name = 'isPub']").combobox({});
            UE.getEditor('editor' + count).addListener("ready", function () {
            });
        } else {
            UE.getEditor('editor' + count).addListener("ready", function () {
                UE.getEditor('editor' + index).execCommand("inserthtml", data.content, true);
            });
            $("#orderNum" + count).numberspinner({
                value: data.orderNum
            });
            $("[class='easyui-linkbutton']").linkbutton({});
            $("#isPub" + count).combobox({
                value: data.ispub
            });
        }
    }
    function getTemplate(id, data) {
        var html = "<td  group='group' align='center'>模&nbsp;&nbsp;&nbsp;&nbsp;板</td>" +
                "<td group='group'>" +
                "<input id='templateId' name='templateId' class='easyui-combobox' style='width:200px;height:28px;'/>" +
                "</td>";
        $("#templateTr").append(html);
        $.ajax({
            type: "get",
            url: store.get("context") + "/doctemplate/dataGrid?categoryId=" + id,
            dataType: "json",
            cache: false,
            success: function (result) {
                var tree = new Array();
                result.rows.forEach(function (it) {
                    var treeNode = new Object();
                    treeNode.id = it.mid;
                    treeNode.text = it.templateName;
                    treeNode.value = it.mid;
                    tree.push(treeNode);
                });
                $("#templateId").combobox({
                    data: tree,
                    editable: false,
                    value: data,
                    onSelect: function (r) {
                        $("[group='editor']").remove();
                        $("#addcontent").show();
                        $.ajax({
                            type: "get",
                            url: store.get("context") + "/doctemplate/" + r.id,
                            dataType: "json",
                            cache: false,
                            success: function (result) {
                                $.each(result.contents, function (index, obj) {
                                    addTemplateContent(obj);
                                });
                            }
                        });
                    }
                });
            }
        });
    }
    function savedraft() {
        if (data) {
            alert('修改时不能保存草稿！');
            return;
        }
        var noHtmlText = "";
        for (var i = 1; i <= count; i++) {
            var context = UE.getEditor('editor' + i).getContent();
            noHtmlText += UE.getEditor('editor' + i).getContentTxt();
            $("#content" + i).val(context);
        }
        $("#content").val(noHtmlText);
        $("#status").val(0);
        $("#form").form({
            url: 'add'
        });
        $("#form").submit()
    }
    function ware(title, url, iconCls, refresh, mid, tag) {
        parent.window.refresh = refresh;
        parent.window.addTab({title: title, url: url, iconCls: iconCls});
    }
    function deleteTemp(tempid) {
        $("[count=" + tempid + "]").remove();
    }
</script>
</body>
</html>

